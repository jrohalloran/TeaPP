<div class="app-wrapper">

  <!-- Top bar -->
  <header class="top-bar">
    <div class="top-bar-content">
    <h1>TeaPP</h1>

    <button mat-button [matMenuTriggerFor]="menu" class="menu-button">
      Menu <mat-icon>arrow_drop_down</mat-icon>
    </button>

    <mat-menu #menu="matMenu">
      <button mat-menu-item (click)="onHome()">Home<mat-icon>home</mat-icon></button>
      <button mat-menu-item (click)="onProfile()">Profile<mat-icon>account_circle</mat-icon></button>
      <button mat-menu-item (click)="onSettings()">Settings<mat-icon>settings</mat-icon></button>
      <button mat-menu-item (click)="newAnalysis()">New Analysis<mat-icon>add</mat-icon></button>
      <button mat-menu-item (click)="onHelp()">Help<mat-icon>question_mark</mat-icon></button>

    </mat-menu>

    <div class = "user-details">
       <h4><mat-icon>account_circle</mat-icon> {{currentUser}}</h4>
       <h4><mat-icon>folder</mat-icon> Dataset</h4>
    </div>

    <button class="help-button" (click)="toggleHelpPanel()">
      <mat-icon>question_mark</mat-icon>
    </button>
  </div>
  </header>
      <div class="help-panel" [class.open]="isHelpOpen">
    <div class="help-header">
      <h3>Help</h3>
      <button class="close-btn" (click)="toggleHelpPanel()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="help-content">
      <h4>Welcome to the Upload Page</h4>
      <p>Here you can upload all data to be stored in the TeaPP databases including:</p>
      <p> - Pedigree Data</p>
      <p> - Environmental Data; Rainfall & Temperature</p>
      <p> - Genomic Data; Fastq files</p>

      <p>Each datatype can be uploaded to TeaPP by selecting its respective tab within the central upload diaply.</p>
      <p>Please see each respective "Help" dropdown for the required file formats.</p>
      <p>After successful upload the data can be explored and analysis in the Homepage. Navigation to the homepage will either occur at the end of upload, or can be selected via the "Menu" dropdown.</p>
    </div>
  </div>  

  <!-- Loading overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate" diameter="60" color="primary"></mat-progress-spinner>
    <div style="margin-top: 10px; font-size: 1.2rem; color: #333;">Uploading data...</div>
  </div>

  <!-- PHASE 1: Centered Upload View -->
  <div *ngIf="showUploader && !apiResult?.length" class="upload-center-container">
    <div class="upload-content">
      <h2>Upload Your Data</h2>
      <p>Please upload the file to begin the analysis.</p>
      <app-file-upload (uploadResponse)="handleUploadResponse($event)"(loadingChange)="loading = $event"></app-file-upload>
    </div>
  </div>

  <app-modal
  [show]="showModal"
  (onConfirm)="onModalConfirm()"
  (onCancel)="onModalCancel()"
  ></app-modal>


  <!-- Main container split left and right -->
  <div *ngIf="apiResult?.length" class="main-split">

    <!-- LEFT PANEL: Instructions + Search (constant) -->
    <section class="left-panel">
      <div class="instruction-box">
        <h3>Instructions</h3>
        <p *ngIf="currentPhaseIndex === 0">
          Review and modify IDs on the right. Use checkboxes to mark items for removal.
        </p>
        <p *ngIf="currentPhaseIndex === 1">
          Use the search below to compare IDs with the full dataset. Results will appear after clicking "Search".
        </p>
      </div>

      <div class="instruction-box">
        <h3>Search</h3>

        <!-- Controlled Search Input -->
        <mat-form-field appearance="outline" class="search-box">
          <mat-label>Search by any field</mat-label>
          <input matInput [(ngModel)]="searchInput" placeholder="Type any ID or parent..." />
        </mat-form-field>

        <!-- Search Button -->
        <button mat-stroked-button color="primary" (click)="performSearch()">
          Search
        </button>

        <!-- Search results -->
        <div *ngIf="searchResults?.length" class="search-results">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th *ngIf="currentPhaseIndex === 0">Correct ID</th>
                <th>Correct Female</th>
                <th>Correct Male</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of searchResults">
                <td>{{ row.ID }}</td>
                <td *ngIf="currentPhaseIndex === 0">{{ row.correct_ID }}</td>
                <td>{{ row.correct_female }}</td>
                <td>{{ row.correct_male }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="searchPerformed && !searchResults.length">
          <p>No matches found.</p>
        </div>
      </div>
    </section>

    <!-- RIGHT PANEL: Tabs only for the tables -->
    <section class="right-panel">
      <mat-tab-group [(selectedIndex)]="currentPhaseIndex">

        <!-- Phase 1 Table -->
        <mat-tab label="Invalid Records">
          <div class="table-container">
            <h3>Invalid Offspring Records Identified</h3>

            <!-- Scrollable table wrapper -->
            <div class="table-scroll-container">
              <table mat-table [dataSource]="apiResult" class="mat-elevation-z8">
                <!-- Columns -->
                <ng-container matColumnDef="ID">
                  <th mat-header-cell *matHeaderCellDef> Original ID </th>
                  <td mat-cell *matCellDef="let element"> {{ element.ID }} </td>
                </ng-container>

                <ng-container matColumnDef="used">
                  <th mat-header-cell *matHeaderCellDef> Present in parent records </th>
                  <td mat-cell *matCellDef="let element"> {{ element.used }} </td>
                </ng-container>

                <ng-container matColumnDef="female_parent">
                  <th mat-header-cell *matHeaderCellDef> Female Parent </th>
                  <td mat-cell *matCellDef="let element"> {{ element.female_parent }} </td>
                </ng-container>

                <ng-container matColumnDef="male_parent">
                  <th mat-header-cell *matHeaderCellDef> Male Parent </th>
                  <td mat-cell *matCellDef="let element"> {{ element.male_parent }} </td>
                </ng-container>

                <ng-container matColumnDef="correct_ID">
                  <th mat-header-cell *matHeaderCellDef> Corrected ID </th>
                  <td mat-cell *matCellDef="let element">
                    <input matInput [(ngModel)]="element.correct_ID" placeholder="Enter ID" style="width: 85%;" />
                  </td>
                </ng-container>

                <ng-container matColumnDef="removed">
                  <th mat-header-cell *matHeaderCellDef> Remove </th>
                  <td mat-cell *matCellDef="let element">
                    <mat-checkbox [(ngModel)]="element.removed"></mat-checkbox>
                  </td>
                </ng-container>

                <!-- Header and Row Definitions -->
                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.removed-row]="row.removed"></tr>
              </table>
            </div>

            <!-- Buttons stay visible below table -->
            <div class="button-container">
              <button mat-stroked-button color="primary" (click)="toggleSelectAllToRemove()">
                {{ areAllRemoved() ? 'Deselect All' : 'Select All to Remove' }}
              </button>
              <button mat-stroked-button color="accent" (click)="toggleSelectUnusedToRemove()" style="margin-left: 8px;">
                {{ areAllUnusedRemoved() ? 'Deselect Unused' : 'Select All Unused' }}
              </button>
              <button mat-raised-button color="primary" (click)="onProceed()">
                Next
              </button>
            </div>
          </div>
        </mat-tab>

        <!-- Phase 2 Table -->
  <mat-tab label="Invalid Parents">
  <div class="table-container" style="position: relative;">
    <!-- Overlay goes here, inside the container -->
    <div
      class="loading-overlay-table"
      *ngIf="loadingTable"
    >
      <mat-progress-spinner mode="indeterminate" diameter="60" color="primary"></mat-progress-spinner>
      <div style="margin-top: 10px; font-size: 1.2rem; color: #333;">Updating Parents...</div>
    </div>

    <h3>Invalid Parents Identified</h3>

    <!-- Scrollable table wrapper -->
    <div class="table-scroll-container">
      <table mat-table [dataSource]="secondTableData" class="mat-elevation-z8">
        <ng-container matColumnDef="ID">
          <th mat-header-cell *matHeaderCellDef> Original ID </th>
          <td mat-cell *matCellDef="let element"> {{ element.ID }} </td>
        </ng-container>

        <ng-container matColumnDef="correct_ID">
          <th mat-header-cell *matHeaderCellDef> Correct ID </th>
          <td mat-cell *matCellDef="let element">
            <input matInput [(ngModel)]="element.correct_ID" placeholder="Enter ID" />
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="secondDisplayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: secondDisplayedColumns;"></tr>
      </table>
    </div>

    <!-- Buttons stay visible below table -->
    <div class="button-container">
      <button mat-raised-button color="primary" (click)="onUpdate()">Update</button>
      <button mat-raised-button color="primary" (click)="finalise()">Upload</button>
    </div>
  </div>
  </mat-tab> 
</mat-tab-group>
</section> 
</div> 
</div> 

